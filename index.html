<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FindMe BLE</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
font-family:system-ui;
margin:0;
background:#0f172a;
color:white;
padding:20px;
}
.card{
background:#1e293b;
border-radius:20px;
padding:20px;
max-width:420px;
margin:auto;
}
button{
width:100%;
padding:14px;
border-radius:12px;
border:none;
margin-top:10px;
font-weight:bold;
}
.primary{background:#3b82f6;color:white;}
.secondary{background:#334155;color:white;}
#map{height:320px;margin-top:15px;border-radius:15px;display:none;}
.online{color:#22c55e;}
.offline{color:#ef4444;}
</style>
</head>

<body>

<div class="card">
<h2>Owner Mode</h2>

<p>Device: <b id="deviceName">None</b></p>
<p>Status: <b id="status" class="offline">Not Connected</b></p>

<button class="primary" onclick="connectTag()">Connect Tag</button>
<button class="secondary" onclick="showLocation()">üìç Show Last Location</button>

<div id="map"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>

/* ---------- FIREBASE CONFIG (YOURS ALREADY USED) ---------- */

const firebaseConfig = {
apiKey:"YOUR_KEY",
authDomain:"YOUR_DOMAIN",
projectId:"YOUR_PROJECT_ID",
storageBucket:"YOUR_BUCKET",
messagingSenderId:"YOUR_ID",
appId:"YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- VARIABLES ---------- */

let myTagId=null;
let map,marker;
let lastSeenLat=null,lastSeenLng=null;
let lostTimer;

/* ---------- CONNECT OWNER ---------- */

async function connectTag(){
try{
const device = await navigator.bluetooth.requestDevice({
acceptAllDevices:true
});

myTagId=device.id;

document.getElementById("deviceName").innerText =
device.name || "BLE Device";

updateStatus(true);

/* WATCH ADVERTISEMENTS */
await device.watchAdvertisements();

device.addEventListener('advertisementreceived',()=>{
updateStatus(true);
clearTimeout(lostTimer);

lostTimer=setTimeout(()=>{
updateStatus(false);
},15000);
});

listenFirebase();

}catch(e){
alert("Bluetooth failed");
console.log(e);
}
}

function updateStatus(connected){
const el=document.getElementById("status");
if(connected){
el.innerText="Connected & In Range";
el.className="online";
}else{
el.innerText="OUT OF RANGE";
el.className="offline";
navigator.vibrate?.([300,100,300]);
}
}

/* ---------- COMMUNITY SCAN ---------- */

async function startCommunityScan(){

/* FORCE LOCATION PERMISSION FIRST */
navigator.geolocation.getCurrentPosition(async(pos)=>{

alert("Location enabled. Scanning started.");

const device = await navigator.bluetooth.requestDevice({
acceptAllDevices:true
});

await device.watchAdvertisements();

device.addEventListener('advertisementreceived',async(event)=>{

const lat=pos.coords.latitude;
const lng=pos.coords.longitude;

await db.collection("tags").doc(event.device.id).set({
lat:lat,
lng:lng,
time:Date.now()
},{merge:true});

});

},()=>{
alert("Location permission required.");
},{enableHighAccuracy:true});
}

/* ---------- FIREBASE LISTENER ---------- */

function listenFirebase(){
if(!myTagId)return;

db.collection("tags").doc(myTagId)
.onSnapshot(doc=>{
if(!doc.exists)return;

const d=doc.data();
lastSeenLat=d.lat;
lastSeenLng=d.lng;

navigator.vibrate?.([400,200,400]);
});
}

/* ---------- MAP ---------- */

function showLocation(){
if(!lastSeenLat){
alert("No location saved yet.");
return;
}

document.getElementById("map").style.display="block";

setTimeout(()=>{

if(!map){
map=L.map('map').setView([lastSeenLat,lastSeenLng],17);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:19}
).addTo(map);

marker=L.marker([lastSeenLat,lastSeenLng])
.addTo(map)
.bindPopup("Last Seen Here")
.openPopup();
}else{
map.setView([lastSeenLat,lastSeenLng],17);
marker.setLatLng([lastSeenLat,lastSeenLng]);
}

map.invalidateSize();

},200);
}

</script>
</body>
</html>
